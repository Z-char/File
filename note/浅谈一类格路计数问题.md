本文可能是原封不动的照抄了参考文献，参考文献链接见文章底部。

## 0. 本文所用记号和定义
以下定义基于如下行走方式：
$(x, y) \to (x + 1, y + 1)$ 或 $(x, y) \to (x + 1, y - 1)$。

1. 路径与整点相交次数为相交整点个数。
2. 记号 $[a, b, c, d]$ 表示 $(a, b)$ 走到 $(c, d)$ 的方案数。
3. 记号 $<a, b, c, d, k>$ 表示 $(a, b)$ 走到 $(c,d)$ 并且与 $y = k$ **相交** 的路径数。
4. 记号 $\{a, b, c, d, k\}$ 表示 $(a, b)$ 走到 $(c, d)$ 且与 $y = k$ **不相交** 的路径数。
5. 记号 $[a, b, k]$ 表示 $(0, 0)$ 走到 $(a, b)$ 的所有路径与 $y = k$ 的相交次数和。
6. 记号 $|a, b, k_1, k_2|$ 表示 $(0, 0)$ 走到 $(a, b)$ 与 $y = k_1, y = k_2$ 都 **不相交** 的路径数。
7. 记号 $\langle a, b, k_1, k_2 \rangle$ 表示 $(0, 0)$ 走到 $(a, b)$ 与 $y = k_1$ **相交** 但与 $y = k_2$ **不相交** 的路径数。

事实上，上文中的起点都是不必要的，都可以转化为从 $(0, 0)$ 开始，我会在每次计数后整理 $(a, b)$ 表示 $(0, 0)$ 走到 $(a, b)$ 的方案数，以及，如果我使用的记号没有前两维，默认从 $(0, 0)$ 开始。

## 1. 无限制的路径计数
即求 $[a, b, c, d]$。

简单组合数问题，由于只能右上右下，那么 $c - a$ 就是总的步数，$d - b$ 是上比下多的个数，即 $x + y = c - a, x - y = d - b$，$x = (c-a+d-b)/2$，那么方案数就是从中选出上即可，即 $\binom{c-a}{\dfrac{c-a+d-b}{2}}$。

也就是：

$$
(a, b) = \binom{a}{\dfrac{a + b}{2}}
$$

## 2. 有一条直线的路径计数

即求 $\{a, b, c, d,k\}, <a, b, c, d, k>$。

显然他们的和是 $[a, b, c, d]$，于是只需要求出任意一个即可。

事实上，$\{a, b, c, d, k\}$ 就是 catalan 扩展，只不过是把坐标轴斜了过来而已。

考虑求 catalan 数经典技巧，对称。

![[image-20220316100726375.png]]

> 图片可能均来自参考文献，参考文献链接见文章末尾。

那么从 $(a, b)$ 走到 $(c, 2k - d)$ 的一条路径就对应一条 **相交** 路径，这是显然的，考虑第一个交点翻折上去即可得到，并且一条 **相交路径** 一定对应这样一条路径，在第一个交点处向下翻折即可，这构成双射，故 $<a, b, c, d, k> = [a, b, c, 2k - d]$，那么 $\{a, b, c, d, k\} = [a, b, c, d] - [a, b, c, 2k - d]$。

也就是：

$$
\begin{align}
<a, b, k> = [a, 2k - b]\\
\{a, b, k\}=[a, b] - <a, b>
\end{align}
$$

## 3. 与一条直线的相交次数和
即求 $[a, b, k]$。

这部分证明我并没有深刻理解。

在这里给出结论：

$$
[a, b, k] = \begin{cases} 
\sum\limits_{i=\dfrac{a+b}{2}+1}^{a+1} \binom{a+1}{i}, 0\le k \le b \\
\sum\limits_{i=\dfrac{a-b}{2}+k+1}^{a+1} \binom{a+1}{i}, \rm otherwise
\end{cases}
$$

好像又理解了，他到最后才说明前面计算的是钦定 $k$ 在中间的，这非常不好，大体想法就是将问题递归化简，考虑把最后一个交点单独拿出来，这就是 $<a, b, k>$，接下来枚举直线上可能有交的所有点，考虑计算经过他的路径(要求后半部分路径至少有一个交，即这个点不允许是最后一个交点)，发现可以递归化简，问题就做完了，时间复杂度为线性。

这同时是一种贡献转化和算两遍思想，首先是路径交点和转化为枚举交点，求合法路径个数，然后是算两遍，一种是直接计算，另一种是强行分类为最后一个交点和其他交点，这样剩下的方案数交点都减少一，递归到下一层次求解。

## 4. 有两条直线的路径计数

即求 $|a, b, k_1, k_2|, \langle a, b, k_1, k_2 \rangle$。

显然只需要求出其中一个即可，容易推知另一个。

首先我们规定 $k_1, k_2$ 把 $b$ 夹在中间，否则第一种无解，第二种就是总方案数。

直接求 $|a, b, k_1, k_2|$。

自然地可以想到容斥。

不考虑限制的总方案数是 $[a, b]$。

考虑至少经过一次上边界的线，我们把原点关于 $k_1$ 对称就得到 $(0, 2k_1)$，计算此时走到终点无限制的方案数，就是至少经过一次的，再把对称点关于 $k_2$ 对称，求方案数，就得到至少经过一组 "上下" 的方案数，继续对称，直到不能对称为止，那么不妨设一条线经过 $k_1$ 为 A，经过 $k_2$ 为 B，那么一条非法线可以描述成形如 AABBABABABABA 的格式，那么我们上面做的过程相当于强制减去含有 A 子序列的，加上含有 AB 的，减去含有 ABA 的，于是我们可以把非法线段简化成 ABABABA 形式，不难发现，ABABABA 会被上述操作计算 -1+1-1+1-1+1-1 = -1 次，然而，ABABAB 会被上述操作计算 -1+1-1+1-1+1 = 0 次，BABA 会被计算 -1+1-1 = -1 次，BAB 会被计算 -1+1 = 0 次，于是我们少减去了形如 BAB 和 AB 这样的线，那么我们考虑至少经过一次下边界的线，即我们以下边界为起点，再做一遍容斥，减去 B 加上 BA 减去 BAB...，不难发现 BAB 和 AB 会被计算 -1 次，剩余两种不会被计算，这样我们就恰好减去了所有的非法路径，由于翻折一次竖直距离至少是乘 2 的，若横向距离甚至比不过竖直距离我们就寄了，显然走不过去，所以最多进行 $\log n$ 次反射，预处理组合数相关可以 ${\cal O}(1)$ 计算方案数，总复杂度为 ${\cal O}(\log n)$。

