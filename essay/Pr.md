#### min-max 容斥

##### 结论：

$$
\max(s) = \sum_{t \subseteq s} (-1)^{|t| - 1} \min(T) \\
\min(s) = \sum_{t \subseteq s} (-1)^{|t| - 1} \max(T) \\
$$

第一次听说这个东西的时候感觉很弱智，因为为什么我不直接求 $\min, \max$ 反而借助一个指数级别的东西求呢？

由于这是 `Probability theory` 随笔，所以不难想到 min-max 容斥在期望意义下也成立：
$$
E(\max(s)) = \sum_{t \subseteq s} (-1)^{|t| - 1} E(\min(T)) \\
E(\min(s)) = \sum_{t \subseteq s} (-1)^{|t| - 1} E(\max(T)) \\
$$
而期望的 min-max 并不好求，不过有的时候 min 不好求得时候 max 比较好求，这时候就需要借助 min-max 容斥来处理了。

##### 扩展：

如果我们希望求 kth 呢？

还是考虑容斥，设出容斥系数：
$$
kthmax(s) = \sum_{t\subseteq s} F(|t|) \min(t)
$$
不妨设 $s$ 集合已经排好序了，那么考虑一个元素 $a_i$，他被贡献的次数。

一个元素被贡献，当且仅当它是集合里最小的元素，那么对于 $i$，前面 $i - 1$ 个元素任选，后面不可选，这样的集合 $t$ 可以贡献给自己，那么枚举集合大小，并依据柿子有：
$$
cnt(i) = \sum_{j=1}^{i-1} F(j + 1) \binom{i - 1}{j}
$$
因为求的是 $kthmax$，所以要有 $cnt(i) = [i = k]$。

上面的柿子看起来比较二项式反演，不过上指标没到 $i$，我们可以改写成要求：
$$
\sum_{j=1}^i F(j + 1)\binom{i}{j} = [i = k - 1]
$$
那么二项式反演得到：
$$
F(j + 1) = \sum_{i\le j} (-1)^{j-i} \binom{j}{i} [i = k - 1] = (-1)^{j-k+1}\binom{j}{k-1}
$$
所以：
$$
F(j) = (-1)^{j - k} \binom{j - 1}{k - 1}
$$
那么：
$$
kthmax(s) = \sum_{t\subseteq s} (-1)^{|t|-k}\binom{|t|-1}{k-1} \min(t)
$$
$kthmin$ 的反演和其完全对称。

代入 $k = 1$，我们就得到了一开始的 min-max 容斥。

更为厉害的，$kth$ 反演在期望意义下仍然成立。

#### 连续型随机变量

##### 概率密度函数

令 $X$ 为一随机变量，若存在一非负实函数 $f(x)$，满足对于任意实数 $a \lt b$，有：
$$
P(a \le X \lt b) = \int_a^b f(x) \dd x
$$
则称 $f(x)$ 为 $X$ 的概率密度函数。

##### 概率分布函数

$$
F(x) = \int_{-\infin}^x f(t) \dd t
$$

有：
$$
P(a\le X \lt b) = F(b) - F(a)
$$
这是由于概率分布函数和概率密度函数的积分关系。

#### PGF

PGF(`Probability Generating Function`)，即概率生成函数。

我们定义一个形式幂级数 $A(x)$，称它为 **离散随机变量** $X$ 的概率生成函数，当且仅当对于 $A(x)$ 的每一项 $a_i$，都有 $a_i = P(X = i)$。

即：
$$
A(x) = \sum_{i \ge 0} P(X = i) x^i
$$

##### 性质

$$
A(1) = \sum_{i=0}^{\infin} P(X=i) = 1
$$

---

$$
A^{(1)}(x) = \sum_{i=0}^{\infin} iP(X = i) x^{i - 1} \\
A^{(1)}(1) = E(X)
$$

##### 应用

###### [CTSC2006]歌唱王国

[link](https://www.luogu.com.cn/problem/P4548). 

令离散型随机变量 $X$ 表示停止时的长度，所求即 $E(X)$。

令 $f(i)$ 表示 $P(X = i)$，令 $g(i)$ 表示 $P(x \gt i)$，或者说，$f(i)$ 表示 $i$ 长度停止的概率，$g(i)$ 表示还没停止的概率。

有 $g(i) = P(X \gt i) = P(X = i + 1) + P(X\gt i + 1) = f(i + 1) + g(i + 1)$。

考虑 $f, g$ 的 PGF 为 $F, G$.

由上式有 $xG + 1 = F + G$，其中 `+1` 是因为 $g(0) = 1$。

由于 PGF 的性质，所求即 $F'(1)$。

因为 $F = (x-1)G + 1$，所以 $F' = G + (x-1)G'$，所以 $F'(1) = G(1)$。

事实上，上面这部分其实不必要使用 PGF，是期望的经典转化 $\sum i P(X = i) = \sum P(X \gt i)$。

考虑再找一个关于 $F, G$ 的方程，从而得到 $F'(1)$。

考虑事件 $H_i$，表示抽卡 $i$ 次后仍然没有抽出序列，然后恼羞成怒修改抽奖机制连续抽出 $m$ 张，并恰好是所求序列的概率。

考虑分别用 $f, g$ 表示这个东西。

对于 $g$，概率显然是 $g(i) \times (1/n)^m$，因为两部分是独立的，所以分别求并乘起来即可。

对于 $f$，考虑枚举在 $i + j$ 的位置第一次抽出，那么概率就是 $\sum_{j=1}^m f_{i+j} a_j (1/n)^{m-j}$，其中 $a_j$ 表示是否有可能在 $j$ 位置匹配，因为如果在 $j$ 位置匹配，由于事件特性，这是前缀，而因为匹配，这是后缀，所以这必须是 `border` 才有可能匹配，所以 $a_j$ 表示 $j$ 位置是否是原串的一个 `border`。

那么：
$$
g(i) \left(\dfrac{1}{n}\right)^m = \sum_{j=1}^m f(i+j) a_j \left(\dfrac{1}{n}\right)^{m-j} \\
G(x) \left(\dfrac{x}{n}\right)^m = \sum_{j=1}^m F(x) a_j \left(\dfrac{x}{n}\right)^{m-j}
$$
要求 $G(1)$，所以代入 $x = 1$。
$$
G(1)\dfrac{1}{n^m} = \sum_{j=1}^m a_j \dfrac{1}{n^{m-j}}
$$
其中利用了 PGF 的性质 $F(1) = 1$ .

那么：
$$
G(1) = \sum_{j=1}^m a_jn^j
$$
那么对于每个串跑一遍 kmp，暴力枚举 `border`，直接计算即可，复杂度为 ${\cal O}(t m)$。

