## LOJ2340

[loj2340](https://loj.ac/p/2340). 

不合法划分其实就是联通 + 存在 euler 回路，因为 $n$ 很小，所以可以暴力枚举子集然后计算是否合法。

考虑 dp，答案显然是：
$$
f_s = \sum_{t \subseteq s, t \neq \varnothing} f_{s - t} \left(\dfrac{w_t}{w_s}\right)^p [legal(t) = 1]
$$
复杂度为 $3^n$，无法通过。

把 $w_s$ 提前当成一个和 $s$ 相关的常数，将 $w_t$ 和 $legal(t)$ 看成一个关于 $t$ 的整体，不妨记作 $g_t$。

于是：
$$
f_s = k(s) \sum_{t \subseteq s, t \neq \varnothing} f_{s - t} g_t
$$
如果不考虑 $k(s)$，后面的部分就是单纯的子集卷积，因为 $f_s = 0$ 所以 $t = \varnothing$ 也无所谓，子集卷积就完事了。

所以这就是一个半在线子集卷积。

具体的，按照占位多项式从低往高处理，这一层暴力从底下卷上来，如果答案不仅仅是子集卷积，那么 `ifwt` 然后逐个修正然后 `fwt` 即可。

卷积总复杂度为 $2^n n^2$，`fwt` 总次数为 $n + 2n$ 次($g$ + $f$ 总次数)，总复杂度为 ${\cal O}(2^n n^2)$，还带一个 $4$ 级别的常数，能过真是奇迹。

![](https://gitee.com/Z_char/utools_tc/raw/master/picture/1644454901554-2022-2-10-09:01:42-n1s9i6elek.png)

[Submission(2)](https://uoj.ac/submission/534269). 因为 LOJ 爆炸了所以没有放 LOJ 的提交记录(22-2-10 10:30)，浴谷还是快啊，比 uoj 评测快许多。

`hydro` 这远端评测抓取有点离谱 [TLE 记录](https://hydro.ac/d/luogu/record/6204791a7f605782b6393620)。

---

loj 评测机活了，[Submission](https://loj.ac/s/1377212). 

## AGC43C

[agc43c](https://atcoder.jp/contests/agc043/tasks/agc043_c). 

`inf` 的和次方显然是告诉我们按照和贪心，由于和相同的点之间没有连边，所以直接贪心，能选则选就是最优解，故可以给边定向，让和小的指向大的，若一个点后继有一个选的，那么不能选，若一个点后继都没有选，那么他要选。

这个转移很像博弈论，如果后继有一个必败态，那么必胜，如果后继都是必胜态，那么必败，必败点对应选，必胜对应不选。

所以一个点 $(a, b, c)$ 选等价于现在有三个棋子放在三个图上，形如 $(a, b, c)$，每次可以在对应图上移动一条边，这个点是必败点。

必败点等价于 `sg(a, b, c) = 0`，而根据 `sg` 经典结论，三个图是独立游戏，那么这等价于 $sg_x(a) \oplus sg_y(b) \oplus sg_z(c) = 0$，其贡献是 $inf^{a +b + c}$。

考虑在三个图上暴力跑出 `sg` 值，构造三个集合幂级数，$x_a$ 贡献到 $F_a$ 的 $x^{sg_x(a)}$ 的位置，贡献是 $inf^{a}$，把三个集合幂级数做异或卷积，$ANS(\varnothing)$ 即为所求。

暴力跑出 `sg` 的复杂度是 $m + n \sqrt m$ 的，首先对于每个点枚举连边的点，并在数组里打标记，这是 $m$ 的，接下来就是指针暴力往上跳求出 `sg` 了，注意到一个 $m$ 条边的图 `sg` 最大只有 $\sqrt m$，因为一个 $i$ 的 `sg` 值需求 $0 \to i - 1$ 都出现过，而且至少贡献 $i$ 条边，所以 `sg` 最大值对应的边数是平方级别的，所以 `sg` 最大只有 $\sqrt m$，或者你用 `set` 维护，更省心一点，复杂度多一个 $\log$。

等等，最大值只有 $\sqrt m$？那我们何必 `fwt` 异或卷积呢，直接暴力枚举第一个图和第二个图选的 `sg` 值，直接可以 ${\cal O}(m)$ 求出答案。

[Submission(6)](https://atcoder.jp/contests/agc043/submissions/29192679). 

因为一些玄学原因，$n$ 开到 `3e5` 才过，不是很懂。

## Bzoj3529

[bzoj3529](https://hydro.ac/d/bzoj/p/3529). 
$$
\begin{aligned}
\sum_{i=1}^n\sum_{j=1}^m \sigma ((i, j)) = \sum_{T=1}^n \left\lfloor \dfrac{n}{T} \right\rfloor \left\lfloor \dfrac{m}{T} \right\rfloor f(T)
\end{aligned}
$$
其中 $f(T) = \sum_{g \mid T} \sigma(g)\mu\left(\dfrac{T}{g}\right)[\sigma(g) \le a]$。

离线询问按 $a$ 排序，用 bit 维护 $f$，数论分块求解即可。

代码咕了。

## Luogu4495

[luogu4495](https://hydro.ac/d/luogu/p/P4495). 

由裴蜀定理，等价于问多少个子集和 $p$ 的 $\gcd$ 是 $w$ 的约数。

可以先把所有数对 $p$ 取 $\gcd$(包括 $w$)。

发现剩下的 $\gcd$ 一定是 $p$ 的约数，`1e9` 范围内 $d$ 最大只有 `1344`。

先把所有约数搞出来，然后拿个桶维护一下每个数出现次数，然后每个数暴力枚举约数，对约数位置 `+1` 贡献，这样 $2^{cnt(i)} - 1$ 表示有多少个子集的 $\gcd$ 是 $i$ 的倍数，简单容斥可以得到 $f(i)$ 表示有多少个子集的 $\gcd$ 是 $i$，然后简单求和就可以得到答案。

搞出约数 $\sqrt p$，枚举约数 $d^2$，容斥 $d^2$，求和 $d^2$。

复杂度为 ${\cal O}(\sqrt p + d^2)$，可能还有一个 `map` 的复杂度。

[Submission(0)](https://hydro.ac/d/luogu/record/6204ca7d3bf2009cb933f6d4). 

## Luogu5366

[luogu5366](https://hydro.ac/d/luogu/p/P5366). 

若 $L$ 不是 $G$ 的倍数，那就是无解。

否则先不考虑 $X$，问题可以转化成，在 $1 \to N/G$ 中，选择一些数，使得 $\rm gcd = 1, lcm = L / G$。

考虑对 $L/G$ 分解质因数，其最多有 $8$ 个不同的质因数，如果对每个质因数 $p$ 考虑，设其指数为 $k$，那么问题转化为，选一些数，使得其中 $p$ 的指数最大为 $k$，最小为 $0$。

设有 $m$ 个不同的质因数，那么 $1 \to N/G$ 每个数可以写成一个 $2m$ 长的 $01$ 串，前 $m$ 位表示是否满足 $p_i$ 最大值的限制，后 $m$ 位表示是否满足 $p_i$ 最小值的限制，特别的，如果其有一个 $p_i$ 很大，他是不能选的，应该被归入垃圾(雾)一类。

那么现在的问题就是选若干数，使得他们或起来是一个 $2m$ 长的全 $1$ 串。

看起来还是很不可做，但是观察一下可以发现，非垃圾的数一定是 $L/G$ 的约数，而 `1e8` 内的约数个数最多为 $768$ 级别，故可以直接跑出来这些数字的状态(指对应的串)。

考虑容斥，设 $f(s)$ 表示或出来 $s$ 的方案数，$g(s)$ 表示至多 $s$ 的方案数，经典容斥。

考虑加入 $x$，钦定一开始选了 $x$，那么 $g(s)$ 表示选了 $s$，且钦定选 $x$ 的方案数，不难发现 $g(s) = [s_x \subseteq s] 2^{t(s) - 1}$，其中 $t(s)$ 表示有多少个数是 $s$ 的子集，`-1` 表示 $x$ 你没的选，剩下的随意。

不难发现答案只和 $s_x$ 有关，而且总的 $s$ 个数只有 $2^{2m}$ 次方个，如果加上记忆化，每个只会枚举一次超集，总复杂度就是 $3^{2m}$，由于 $m \le 8$，所以随便过。

代码咕了。

