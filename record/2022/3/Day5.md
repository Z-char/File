## Luogu4707

[luogu4707](https://www.luogu.com.cn/problem/P4707). 

设 $t_i$ 表示 $i$ 原料第一次出现的时间。

所求即 $t$ 中的 $kthmin$ 的期望。

注意到 $\max$ 比较难求，但是 $\min$ 很好求，可以先把 $kthmin$ 转换为 $kthmax$，毕竟最小值就是 $n$ 大值(之所以转化成难求的是因为我们后面还要 kth 容斥)。

那么：
$$
kthmax(s) = \sum_{t\subseteq s}(-1)^{t-k}\binom{t-1}{k-1} (m/w_t)
$$
其中 $m / w_t$ 就是 $\min(t)$。

那么一个自然的做法就是设 $f(i, j, t)$ 表示考虑完前 $i$ 个物品，目前的 $w$ 和为 $j$，集合大小为 $t$ 的方案数，最后考虑所有状态对答案的贡献即可。

这是 ${\cal O}(n^2m)$ 的，并过不去。

注意到数据范围中一个比较奇特的地方 $|n - k| \le 10$，由于我们转换了 $kthmin, kthmax$，所以我们柿子里的 $k \le 11$。

考虑 $k = 1$ 的时候怎么做，不难发现我们会直接设 $f(i, j)$ 表示 $i$ 物品和为 $j$ 的带权方案数，直接把 $-1$ 塞到结果里，从而不记集合的大小。

于是我们想到这个说不定也可以把集合大小压掉，不过，由于 $k$ 给这么小，大概率是要从 $1 \to k$ 递推上来的，所以尝试设 $f(i, j, k)$ 表示 $i$ 物品和为 $j$ 的集合在 $kth$ 下的带权贡献和。

考虑如何转移，首先，不选 $i$，这就是 $f(i - 1, j, k)$，其次，选 $i$，这就比较困难了，我们来尝试一下把他拆成一些低次项(低 th)的 $f$ 来转移，我们考虑枚举 $ 1\to i - 1$ 的集合来计算贡献和：
$$
\begin{align}
\sum_{t \subseteq T_{i-1}} (-1)^{t - k + 1} \binom{t - 1 + 1}{k - 1} &= \sum (-1)^{t-k+1}\l( \binom{t - 1}{k - 1} + \binom{t - 1}{k - 2} \r) \\
&= (-1)\sum(-1)^{t-k}\binom{t-1}{k-1} + (-1)^2 \sum (-1)^{t - (k - 1)} \binom{t - 1}{(k - 1) - 1}
\end{align}
$$
前面那一半就是 $(-1) f(i - 1, j - w_i, k)$，后面那一半就是 $(-1)^2 f(i - 1, j - w_i, k - 1)$。

于是就有 $f(i, j, k) = f(i - 1, j, k) - f(i - 1, j - w_i, k) + f(i - 1, j - w_i, k - 1)$。

总时间复杂度为 ${\cal O}(nmk)$，空间复杂度为 ${\cal O}(nmk)$，显然可以用滚动数组优化空间，这里不再赘述。

边界条件为 $f(0, 0, 0) = 1$。

## AGC008F

[agc008f](https://www.luogu.com.cn/problem/AT2268). 

可以先考虑部分分做法，即 $s_i = 1$ 的问题。

令 $f(x, d)$ 表示 $x$ 染色距离 $d$ 的染色情况。

由于全局染色总是可行的，那么我们不妨把它单独考虑，最后 +1 即可。

对于其余染色情况，可能是 $f(x_1, d_1)$，或者 $f(x_2, d_2)$，诸如此类，考虑对于某个染色情况，我们选取 $d_i$ 最小的 $f(x_i, d_i)$ 来计数，这样可以做到不重不漏。

考虑一个 $f(x, d)$ 什么时候是可行的，由于所有点都是染色点，那么只需要考虑旁边的点的 $f(y, d - 1)$ 和 $f(x, d)$ 相同即可。

那么若 $f(x, d)$ 和 $f(y, d - 1)$ 相同，就意味着 $y$ 出发 $d - 1$ 步完全覆盖了 $x$ 的其他子树，那么 $maxd(x, y) \le d - 1$，其中 $maxd(x, y)$ 表示 $x$ 删除 $y$ 子树的最远距离。

那么若要 $f(x, d)$ 合法，就是要 $d - 1 \lt maxd(x, y)$，就是要 $d \le maxd(x, y) +2$，那么 $f(x, d)$ 合法，就是对于任何 $y$，其 $maxd(x, y) + 2$ 作为上界，取最小值，令 $maxd(x, 0)$ 表示 $x$ 不限制子树的最远点，不妨设其处于 $yy$ 子树，那么若不取 $maxd(x, yy) + 2$，其他的子树都会是 $maxd(x, 0) + 2$，故最小值就是 $maxd(x, yy) + 2$，事实上，这就是直径 dp 里面的 smx，直接 dp 即可。

由于限制了全局不能取，那么一个点的 $d$ 合法范围就是 $[0, \min(maxd(x, 0) - 1, smx + 2)]$，也就是覆盖全局之前和被取代之前，直接求和 $r - l$ 即可。

对于不是所有点都是关键点的情况。

将他们都当作关键点，对于非关键点，处理出切实能够覆盖的 $d$ 的下界，因为有一些 $d$ 是不能切实覆盖的，考虑一个非关键点 $y$ 和一个关键点 $x$，若 $f(y, d_1) = f(x, d_2)$，一定意味着 $y$ 延申 $d_1$ 后把 $x$ 子树完全覆盖了，所以 $y$ 的 $d$ 就是最小的距离，从 $y$ 到 $x$ 再到叶子，可以换根 dp 处理，上面的同理。

于是就做完了，复杂度为 ${\cal O}(n)$。

